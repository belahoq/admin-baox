<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Builder (v21 - Stable)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color:white; margin-top:5px; transition: 0.2s; }
        .btn:hover { filter: brightness(0.9); }
        .btn-blue { background: #3498db; } 
        .btn-green { background: #27ae60; } 
        .btn-orange { background: #e67e22; width: auto; padding: 8px 15px; }
        .btn-yellow { background: #f1c40f; color: #333; }

        .hidden { display: none; }
        .box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e1e4e8; }
        
        /* Provider Toggle */
        .provider-switch { display: flex; gap: 10px; margin-bottom: 10px; }
        .provider-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; border: 2px solid #ddd; border-radius: 5px; font-weight: bold; opacity: 0.6; }
        .provider-btn.active { border-color: #2ecc71; background: #eafaf1; color: #27ae60; opacity: 1; }
        
        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .badge-draft { background: #f39c12; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        .preview-img { max-height: 150px; display: none; margin: 10px auto; border-radius: 5px; border: 1px solid #ddd; }
        .alert { padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 14px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Admin Sekolah (Auto-Draft)</h2>
    <div id="status_msg"></div>

    <div id="login-section" style="text-align: center; padding: 40px;">
        <button class="btn btn-blue" onclick="handleAuthClick()">Login Google Blogger</button>
    </div>

    <div id="app-section" class="hidden">
        
        <div class="box">
            <label style="font-size:12px; font-weight:bold;">Pilih Mesin AI:</label>
            <div class="provider-switch">
                <div id="prov_gemini" class="provider-btn active" onclick="switchProvider('GEMINI')">Google Gemini<br><small>(Analisa Gambar)</small></div>
                <div id="prov_groq" class="provider-btn" onclick="switchProvider('GROQ')">Groq Cloud<br><small>(Super Cepat)</small></div>
            </div>

            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="password" id="api_key_input" placeholder="Tempel Gemini API Key..." style="flex:1;">
                <button onclick="fetchModels()" id="btn_cek" class="btn btn-orange" style="margin:0;">Cek AI</button>
            </div>
            
            <div style="display:flex; gap:5px;">
                <select id="model_select" style="margin:0;"><option disabled selected>-- Pilih Model --</option></select>
                <select id="blog_select" style="margin:0;"><option disabled selected>Loading Blog...</option></select>
            </div>
        </div>

        <div class="box">
            <input type="text" id="judul" placeholder="Judul Artikel (Contoh: Prestasi Lomba Puisi)">
            
            <div id="image_input_container">
                <label style="font-size:12px; color:#666;">Gambar Referensi (Hanya untuk dibaca AI):</label>
                <input type="file" id="file_gambar" accept="image/*" onchange="previewImage(this)">
                <img id="imgPreview" class="preview-img">
            </div>
            <div id="groq_warning" class="hidden" style="color: #e67e22; font-size: 12px; margin-bottom: 10px;">
                ‚ö†Ô∏è Groq Mode: Hanya membaca teks judul & deskripsi (Tidak baca gambar).
            </div>

            <select id="cat_select" onchange="toggleManualCat()" style="margin-top:10px;">
                <option value="" disabled selected>-- Kategori --</option>
                <option value="Kegiatan Sekolah">Kegiatan Sekolah</option>
                <option value="Prestasi">Prestasi</option>
                <option value="Pengumuman">Pengumuman</option>
                <option value="NEW">‚ûï Tambah Baru...</option>
            </select>
            <input type="text" id="cat_manual" class="hidden" placeholder="Nama Kategori...">
            
            <textarea id="desc_gambar" style="height:60px;" placeholder="Deskripsi/Poin penting artikel..."></textarea>
            <select id="mode_penulisan"><option value="DEFAULT">Berita</option><option value="TUTORIAL">Tutorial</option><option value="PROFIL">Profil</option></select>
            
            <button onclick="generateContent()" id="btnGen" class="btn btn-green">‚ú® Generate Artikel (Lengkap)</button>
        </div>

        <div class="box">
            <textarea id="kontenEditor"></textarea>
            <button onclick="postToBlogger(true)" class="btn btn-yellow" style="margin-top:15px;">üìÇ Simpan ke DRAFT Blogger</button>
            <center style="margin-top:10px;"><a href="#" onclick="doLogout()" style="color:red; text-decoration:none;">Logout</a></center>
        </div>

        <div class="box" id="history-box">
            <h4>üìú Riwayat Draft (Sesi Ini)</h4>
            <table id="historyTable">
                <thead><tr><th>Jam</th><th>Judul</th><th>Status</th><th>Link</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const CLIENT_ID = '763331219607-vv1dd6jksep9utgs337idu67i57j6baa.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/blogger';
    
    let tokenClient, accessToken = null;
    let globalBase64Img = ""; 
    let currentProvider = "GEMINI"; 

    window.onload = function() {
        switchProvider('GEMINI'); 
        
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    fetchUserBlogs();
                    loadHistory();
                }
            }
        });
        
        tinymce.init({ 
            selector: '#kontenEditor', 
            height: 500, 
            plugins: 'lists code wordcount', 
            toolbar: 'undo redo | bold italic | bullist numlist | code | wordcount', 
            branding: false,
            statusbar: true
        });
    };

    function handleAuthClick() { tokenClient.requestAccessToken(); }
    function doLogout() { google.accounts.oauth2.revoke(accessToken, ()=>{}); location.reload(); }

    function switchProvider(provider) {
        currentProvider = provider;
        const input = document.getElementById('api_key_input');
        const imgContainer = document.getElementById('image_input_container');
        const groqWarn = document.getElementById('groq_warning');

        document.querySelectorAll('.provider-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('prov_' + provider.toLowerCase()).classList.add('active');

        if (provider === 'GEMINI') {
            input.placeholder = "Tempel Google Gemini API Key...";
            if(localStorage.getItem('gemini_api_key')) input.value = localStorage.getItem('gemini_api_key');
            imgContainer.classList.remove('hidden');
            groqWarn.classList.add('hidden');
        } else {
            input.placeholder = "Tempel Groq API Key (gsk_...)...";
            if(localStorage.getItem('groq_api_key')) input.value = localStorage.getItem('groq_api_key');
            imgContainer.classList.add('hidden');
            groqWarn.classList.remove('hidden');
        }
        document.getElementById('model_select').innerHTML = "<option disabled selected>-- Klik Cek AI --</option>";
    }

    function previewImage(input) {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 800;
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    globalBase64Img = canvas.toDataURL('image/jpeg', 0.7).split(',')[1]; 
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function fetchModels() {
        const key = document.getElementById('api_key_input').value;
        const sel = document.getElementById('model_select');
        const btn = document.getElementById('btn_cek');
        
        if(!key) return alert("Isi API Key dulu!");
        btn.innerText = "..."; btn.disabled = true;

        try {
            if (currentProvider === 'GEMINI') {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                if(data.models) {
                    sel.innerHTML = "";
                    data.models.forEach(m => { if(m.supportedGenerationMethods.includes("generateContent")) { 
                        let o=document.createElement('option'); o.value=m.name; o.text=m.displayName; sel.appendChild(o); 
                    }});
                    localStorage.setItem('gemini_api_key', key);
                    alert("Gemini Connected!");
                } else throw new Error("Invalid Key");
            } else {
                const res = await fetch('https://api.groq.com/openai/v1/models', { headers: { 'Authorization': `Bearer ${key}` } });
                const data = await res.json();
                if(data.data) {
                    sel.innerHTML = "";
                    data.data.forEach(m => { 
                        if(!m.id.includes('whisper')) { 
                            let o=document.createElement('option'); o.value=m.id; o.text=m.id; sel.appendChild(o);
                        }
                    });
                    localStorage.setItem('groq_api_key', key);
                    alert("Groq Connected!");
                } else throw new Error("Invalid Key");
            }
        } catch(e) { alert("Gagal koneksi API."); }
        btn.innerText = "Cek AI"; btn.disabled = false;
    }

    async function generateContent() {
        const judul = document.getElementById('judul').value;
        const desc = document.getElementById('desc_gambar').value;
        const apiKey = document.getElementById('api_key_input').value;
        const model = document.getElementById('model_select').value;
        const btn = document.getElementById('btnGen');

        if(!apiKey || !model || !judul) return alert("Data belum lengkap!");
        btn.innerText = `‚è≥ Meracik... (${currentProvider})`; btn.disabled = true;

        // PROMPT SANGAT DETIL AGAR ARTIKEL PANJANG & LENGKAP
        const systemPrompt = `
        BERTINDAKLAH SEBAGAI PENULIS BLOG PROFESIONAL & AHLI SEO.
        
        INSTRUKSI UTAMA:
        1. Tulis artikel LENGKAP minimal 500-800 kata. Jangan terputus.
        2. Gunakan format HTML murni (tanpa markdown).
        3. Struktur Wajib:
           - <h3>Pendahuluan</h3> (Paragraf pembuka yang menarik)
           - <h3>[Sub Judul Relevan 1]</h3> (Penjelasan detail)
           - <h3>[Sub Judul Relevan 2]</h3> (Analisis atau poin penting)
           - <h3>[Sub Judul Relevan 3]</h3> (Dampak atau manfaat)
           - <h3>Kesimpulan</h3> (Penutup yang kuat)
        4. Gaya bahasa: Formal, edukatif, ramah, dan memotivasi.
        5. Gunakan tag <p> untuk paragraf, <ul>/<ol> untuk list, dan <b> untuk bold.
        6. JANGAN ADA TEKS PEMBUKA (Seperti "Tentu", "Berikut ini"). Langsung ke artikel.
        
        TOPIK: "${judul}"
        KONTEKS: "${desc}"
        `;

        let resultText = "";

        try {
            if (currentProvider === 'GEMINI') {
                let parts = [{ text: systemPrompt }];
                if (globalBase64Img && document.getElementById('file_gambar').files.length > 0) {
                    parts.push({ inline_data: { mime_type: "image/jpeg", data: globalBase64Img } });
                }
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // Setting maxOutputTokens tinggi agar artikel tidak terpotong
                    body: JSON.stringify({ 
                        contents: [{ parts: parts }],
                        generationConfig: { maxOutputTokens: 8192 } 
                    })
                });
                const data = await res.json();
                if(data.candidates) resultText = data.candidates[0].content.parts[0].text;

            } else {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "system", content: systemPrompt }],
                        temperature: 0.7,
                        max_tokens: 4096 // Maksimalkan token Groq
                    })
                });
                const data = await res.json();
                if(data.choices) resultText = data.choices[0].message.content;
            }

            if(resultText) {
                // Pembersihan
                resultText = resultText.replace(/```html/gi, '').replace(/```/g, '');
                resultText = resultText.replace(/^(Tentu|Baik|Berikut|Oke|Halo).+?(\n|<)/si, '');
                resultText = resultText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
                
                tinymce.get('kontenEditor').setContent(resultText);
                document.getElementById('kontenEditor').scrollIntoView({behavior: "smooth"});
            }

        } catch(e) { alert("Error Generate: " + e.message); }
        btn.innerText = "‚ú® Generate Artikel (Lengkap)"; btn.disabled = false;
    }

    async function postToBlogger(isDraft) {
        const blogId = document.getElementById('blog_select').value;
        const judul = document.getElementById('judul').value;
        const konten = tinymce.get('kontenEditor').getContent();
        const catS = document.getElementById('cat_select').value;
        const catM = document.getElementById('cat_manual').value;
        let labels = (catS === 'NEW' && catM) ? catM.split(',') : (catS ? [catS] : []);

        if(!accessToken || !blogId) return alert("Login ulang!");
        
        const btn = document.querySelector('.btn-yellow');
        btn.innerText = "‚è≥ Mengirim..."; btn.disabled = true;

        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    kind: 'blogger#post', title: judul, content: konten, labels: labels,
                    status: isDraft ? 'DRAFT' : 'LIVE' 
                })
            });
            const d = await res.json();
            
            if(res.ok) {
                addToHistory(judul, d.url, isDraft);
                // UPDATE PENTING: TIDAK ADA RELOAD HALAMAN
                // Cuma reset form saja biar token tidak hilang
                resetForm();
                
                // Tampilkan pesan sukses
                document.getElementById('status_msg').innerHTML = `
                    <div class='alert alert-success'>
                        ‚úÖ <b>Berhasil!</b> Artikel masuk DRAFT Blogger.<br>
                        Silakan buka <a href='https://draft.blogger.com' target='_blank'>Blogger</a> untuk upload foto & publish.
                    </div>`;
                
                // Scroll ke atas
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } else { alert("Gagal: " + d.error.message); }
        } catch(e) { alert("Error Koneksi"); }
        btn.innerText = "üìÇ Simpan ke DRAFT Blogger"; btn.disabled = false;
    }

    // --- FUNGSI RESET FORM (GANTI RELOAD) ---
    function resetForm() {
        document.getElementById('judul').value = "";
        document.getElementById('desc_gambar').value = "";
        document.getElementById('file_gambar').value = "";
        document.getElementById('imgPreview').style.display = 'none';
        tinymce.get('kontenEditor').setContent("");
        globalBase64Img = "";
    }

    function addToHistory(judul, url, isDraft) {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        let link = url ? url : "https://draft.blogger.com"; 
        history.unshift({ time: new Date().toLocaleTimeString(), title: judul, url: link, status: 'Draft' });
        if(history.length > 5) history.pop(); 
        localStorage.setItem('post_history', JSON.stringify(history));
        loadHistory(); // Refresh tabel langsung
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = "";
        if(history.length === 0) { tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Belum ada riwayat.</td></tr>"; return; }
        history.forEach(item => {
            let badge = `<span class="badge-draft">DRAFT</span>`;
            let link = `<a href="${item.url}" target="_blank">Cek</a>`;
            tbody.innerHTML += `<tr><td>${item.time}</td><td>${item.title}</td><td>${badge}</td><td>${link}</td></tr>`;
        });
    }

    async function fetchUserBlogs() {
        const sel = document.getElementById('blog_select');
        try {
            const res = await fetch('https://www.googleapis.com/blogger/v3/users/self/blogs', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const data = await res.json();
            if (data.items) {
                sel.innerHTML = '';
                data.items.forEach(b => { let opt = document.createElement('option'); opt.value = b.id; opt.text = b.name; sel.appendChild(opt); });
                if(localStorage.getItem('blogger_blog_id')) sel.value = localStorage.getItem('blogger_blog_id');
            }
        } catch(e) {}
    }

    function toggleManualCat() { document.getElementById('cat_manual').classList.toggle('hidden', document.getElementById('cat_select').value !== 'NEW'); }
</script>

</body>
</html>
