<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Blog Builder (Draft Mode)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color:white; margin-top:5px; transition: 0.2s; }
        .btn:hover { filter: brightness(0.9); }
        .btn-blue { background: #3498db; } 
        .btn-green { background: #27ae60; } 
        .btn-orange { background: #e67e22; width: auto; padding: 8px 15px; }
        .btn-yellow { background: #f1c40f; color: #333; }

        .hidden { display: none; }
        .box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e1e4e8; }
        
        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .badge-draft { background: #f39c12; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        .badge-success { background: #2ecc71; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }

        .preview-img { max-height: 150px; display: none; margin: 10px auto; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Admin Sekolah (Draft Mode)</h2>
    <div id="status_msg"></div>

    <div id="login-section" style="text-align: center; padding: 40px;">
        <button class="btn btn-blue" onclick="handleAuthClick()">Login Google Blogger</button>
    </div>

    <div id="app-section" class="hidden">
        
        <div class="box">
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="password" id="api_key_input" placeholder="Gemini API Key..." style="flex:1;">
                <button onclick="fetchModels()" id="btn_cek" class="btn btn-orange" style="margin:0;">Cek AI</button>
            </div>
            <div style="display:flex; gap:5px;">
                <select id="model_select" style="margin:0;"><option disabled selected>-- Pilih AI --</option></select>
                <select id="blog_select" style="margin:0;"><option disabled selected>Loading Blog...</option></select>
            </div>
        </div>

        <div class="box">
            <input type="text" id="judul" placeholder="Judul Artikel">
            
            <label style="font-size:12px; color:#666;">Gambar Referensi (Hanya untuk AI, tidak diupload):</label>
            <input type="file" id="file_gambar" accept="image/*" onchange="previewImage(this)">
            <img id="imgPreview" class="preview-img">

            <select id="cat_select" onchange="toggleManualCat()" style="margin-top:10px;">
                <option value="" disabled selected>-- Kategori --</option>
                <option value="Kegiatan Sekolah">Kegiatan Sekolah</option>
                <option value="Prestasi">Prestasi</option>
                <option value="Pengumuman">Pengumuman</option>
                <option value="NEW">‚ûï Tambah Baru...</option>
            </select>
            <input type="text" id="cat_manual" class="hidden" placeholder="Nama Kategori...">
            
            <textarea id="desc_gambar" style="height:60px;" placeholder="Deskripsi tambahan..."></textarea>
            <select id="mode_penulisan"><option value="DEFAULT">Berita</option><option value="TUTORIAL">Tutorial</option><option value="PROFIL">Profil</option></select>
            
            <button onclick="generateContent()" id="btnGen" class="btn btn-green">‚ú® Generate Artikel</button>
        </div>

        <div class="box">
            <textarea id="kontenEditor"></textarea>
            
            <button onclick="postToBlogger(true)" class="btn btn-yellow" style="margin-top:15px;">üìÇ Simpan ke DRAFT Blogger</button>
            
            <center style="margin-top:10px;"><a href="#" onclick="doLogout()" style="color:red; text-decoration:none;">Logout</a></center>
        </div>

        <div class="box" id="history-box">
            <h4>üìú Riwayat Generate (Sesi Ini)</h4>
            <table id="historyTable">
                <thead><tr><th>Jam</th><th>Judul</th><th>Status</th><th>Link</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const CLIENT_ID = '763331219607-vv1dd6jksep9utgs337idu67i57j6baa.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/blogger';
    let tokenClient, accessToken = null;
    let globalBase64Img = ""; // Hanya untuk dikirim ke Gemini

    window.onload = function() {
        if(localStorage.getItem('gemini_api_key')) document.getElementById('api_key_input').value = localStorage.getItem('gemini_api_key');
        
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    fetchUserBlogs();
                    loadHistory();
                }
            }
        });
        tinymce.init({ selector: '#kontenEditor', height: 400, plugins: 'lists code', toolbar: 'undo redo | bold italic | bullist numlist | code', branding: false });
    };

    function handleAuthClick() { tokenClient.requestAccessToken(); }
    function doLogout() { google.accounts.oauth2.revoke(accessToken, ()=>{}); location.reload(); }

    // --- PREVIEW & CONVERT IMAGE TO BASE64 (FOR AI) ---
    function previewImage(input) {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                // Resize for Gemini (Biar gak berat)
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxW = 800;
                    const scale = maxW / img.width;
                    canvas.width = maxW;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    globalBase64Img = canvas.toDataURL('image/jpeg', 0.7).split(',')[1]; // Ambil data raw base64
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function generateContent() {
        const judul = document.getElementById('judul').value;
        const desc = document.getElementById('desc_gambar').value;
        const apiKey = document.getElementById('api_key_input').value;
        const model = document.getElementById('model_select').value;
        const btn = document.getElementById('btnGen');

        if(!apiKey || !model || !judul) return alert("Data belum lengkap!");
        btn.innerText = "‚è≥ Meracik..."; btn.disabled = true;

        const prompt = `Buat artikel blog sekolah HTML (tanpa markdown). Judul: ${judul}. Deskripsi: ${desc}. Gaya: Formal Ramah. Gunakan <h3>, <p>.`;
        
        // Payload untuk Gemini (Text + Image jika ada)
        let parts = [{ text: prompt }];
        if (globalBase64Img) {
            parts.push({
                inline_data: { mime_type: "image/jpeg", data: globalBase64Img }
            });
        }

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: parts }] })
            });
            const data = await res.json();
            if(data.candidates) {
                let aiText = data.candidates[0].content.parts[0].text.replace(/```html/g,'').replace(/```/g,'');
                tinymce.get('kontenEditor').setContent(aiText);
                
                // Scroll ke editor
                document.getElementById('kontenEditor').scrollIntoView({behavior: "smooth"});
            }
        } catch(e) { alert("Error AI"); }
        btn.innerText = "‚ú® Generate Artikel"; btn.disabled = false;
    }

    async function postToBlogger(isDraft) {
        const blogId = document.getElementById('blog_select').value;
        const judul = document.getElementById('judul').value;
        const konten = tinymce.get('kontenEditor').getContent();
        const catS = document.getElementById('cat_select').value;
        const catM = document.getElementById('cat_manual').value;
        let labels = (catS === 'NEW' && catM) ? catM.split(',') : (catS ? [catS] : []);

        if(!accessToken || !blogId) return alert("Login ulang!");
        
        const btn = document.querySelector('.btn-yellow');
        btn.innerText = "‚è≥ Mengirim..."; btn.disabled = true;

        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    kind: 'blogger#post', 
                    title: judul, 
                    content: konten, 
                    labels: labels,
                    status: isDraft ? 'DRAFT' : 'LIVE' // Setting Status DRAFT
                })
            });
            const d = await res.json();
            
            if(res.ok) {
                // Simpan ke History
                addToHistory(judul, d.url, isDraft);
                
                alert("‚úÖ Sukses! Artikel masuk DRAFT Blogger.");
                
                // Auto Reload halaman (bersihkan form)
                location.reload(); 
            } else {
                alert("Gagal: " + d.error.message);
            }
        } catch(e) { alert("Error Koneksi"); }
        btn.innerText = "üìÇ Simpan ke DRAFT Blogger"; btn.disabled = false;
    }

    // --- HISTORY SYSTEM (LocalStorage) ---
    function addToHistory(judul, url, isDraft) {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        let now = new Date().toLocaleTimeString();
        history.unshift({ time: now, title: judul, url: url, status: isDraft ? 'Draft' : 'Live' });
        if(history.length > 5) history.pop(); // Simpan 5 terakhir aja
        localStorage.setItem('post_history', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = "";
        
        if(history.length === 0) {
            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Belum ada riwayat.</td></tr>";
            return;
        }

        history.forEach(item => {
            let badge = item.status === 'Draft' ? '<span class="badge-draft">DRAFT</span>' : '<span class="badge-success">LIVE</span>';
            let link = item.url ? `<a href="${item.url}" target="_blank">Lihat</a>` : '-';
            let row = `<tr><td>${item.time}</td><td>${item.title}</td><td>${badge}</td><td>${link}</td></tr>`;
            tbody.innerHTML += row;
        });
    }

    async function fetchUserBlogs() {
        const sel = document.getElementById('blog_select');
        try {
            const res = await fetch('https://www.googleapis.com/blogger/v3/users/self/blogs', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const data = await res.json();
            if (data.items) {
                sel.innerHTML = '';
                data.items.forEach(b => { let opt = document.createElement('option'); opt.value = b.id; opt.text = b.name; sel.appendChild(opt); });
                if(localStorage.getItem('blogger_blog_id')) sel.value = localStorage.getItem('blogger_blog_id');
            }
        } catch(e) {}
    }

    async function fetchModels() {
        const key = document.getElementById('api_key_input').value;
        const sel = document.getElementById('model_select');
        const btn = document.getElementById('btn_cek');
        if(!key) return alert("Isi Key!");
        btn.innerText = "...";
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            const data = await res.json();
            if(data.models) {
                sel.innerHTML = "";
                data.models.forEach(m => { if(m.supportedGenerationMethods.includes("generateContent")) { let o=document.createElement('option'); o.value=m.name; o.text=m.displayName; sel.appendChild(o); }});
                localStorage.setItem('gemini_api_key', key);
                alert("OK");
            }
        } catch(e) { alert("Error"); }
        btn.innerText = "Cek AI";
    }

    function toggleManualCat() { document.getElementById('cat_manual').classList.toggle('hidden', document.getElementById('cat_select').value !== 'NEW'); }
</script>

</body>
</html>
